# ì„ì‹œ
```python
# health_check.py
from fastapi import APIRouter, Request
from fastapi.responses import HTMLResponse, JSONResponse
from pydantic import BaseModel
from typing import List, Optional, Dict, Any
from datetime import datetime, timedelta
import os
import glob
import re
from pathlib import Path
from config import config

# Response Schema
class ServiceStatus(BaseModel):
    name: str
    description: str
    status: str  # "OK", "ERROR", "WARNING"
    message: str
    last_log: Optional[str] = None
    last_updated: Optional[datetime] = None
    base_dir: str
    scheduler: str
    run_time: List[str]

class HealthCheckResponse(BaseModel):
    timestamp: datetime
    overall_status: str  # "OK", "WARNING", "ERROR"
    services: List[ServiceStatus]
    summary: str
    total_services: int
    ok_count: int
    error_count: int
    warning_count: int

router = APIRouter()

def check_auto_esafe(program_config: Dict[str, Any]) -> ServiceStatus:
    """auto_esafe í”„ë¡œê·¸ë¨ ìƒíƒœ ì²´í¬"""
    try:
        current_date = datetime.now().strftime("%Y_%m_%d")
        log_dir = Path(program_config["base_dir"]) / "log"
        
        if not log_dir.exists():
            return ServiceStatus(
                name=program_config["name"],
                description=program_config["description"],
                status="ERROR",
                message=f"Log directory not found: {log_dir}",
                base_dir=program_config["base_dir"],
                scheduler=program_config["scheduler"],
                run_time=program_config["run_time"]
            )
        
        # ì˜¤ëŠ˜ ë‚ ì§œì˜ ë¡œê·¸ íŒŒì¼ ì°¾ê¸°
        log_file_pattern = f"auto_esafe_{current_date}.log"
        log_files = list(log_dir.glob(log_file_pattern))
        
        if not log_files:
            return ServiceStatus(
                name=program_config["name"],
                description=program_config["description"],
                status="ERROR",
                message=f"Today's log file not found: {log_file_pattern}",
                base_dir=program_config["base_dir"],
                scheduler=program_config["scheduler"],
                run_time=program_config["run_time"]
            )
        
        log_file = log_files[0]
        
        # ë¡œê·¸ íŒŒì¼ì—ì„œ ERROR ì²´í¬
        try:
            with open(log_file, 'r', encoding='utf-8') as f:
                content = f.read()
                if "ERROR" in content:
                    return ServiceStatus(
                        name=program_config["name"],
                        description=program_config["description"],
                        status="ERROR",
                        message="ERROR found in today's log file",
                        last_log=log_file.name,
                        last_updated=datetime.fromtimestamp(log_file.stat().st_mtime),
                        base_dir=program_config["base_dir"],
                        scheduler=program_config["scheduler"],
                        run_time=program_config["run_time"]
                    )
        except Exception as e:
            return ServiceStatus(
                name=program_config["name"],
                description=program_config["description"],
                status="ERROR",
                message=f"Failed to read log file: {str(e)}",
                base_dir=program_config["base_dir"],
                scheduler=program_config["scheduler"],
                run_time=program_config["run_time"]
            )
        
        # ê°€ì¥ ìµœê·¼ ë¡œê·¸ íŒŒì¼ ì°¾ê¸°
        all_log_files = list(log_dir.glob("auto_esafe_*.log"))
        if all_log_files:
            latest_log = max(all_log_files, key=lambda x: x.stat().st_mtime)
            last_log_name = latest_log.name
            last_updated = datetime.fromtimestamp(latest_log.stat().st_mtime)
        else:
            last_log_name = None
            last_updated = None
        
        return ServiceStatus(
            name=program_config["name"],
            description=program_config["description"],
            status="OK",
            message="No errors found in today's log",
            last_log=last_log_name,
            last_updated=last_updated,
            base_dir=program_config["base_dir"],
            scheduler=program_config["scheduler"],
            run_time=program_config["run_time"]
        )
        
    except Exception as e:
        return ServiceStatus(
            name=program_config["name"],
            description=program_config["description"],
            status="ERROR",
            message=f"Unexpected error: {str(e)}",
            base_dir=program_config["base_dir"],
            scheduler=program_config["scheduler"],
            run_time=program_config["run_time"]
        )

def check_kindscrap(program_config: Dict[str, Any]) -> ServiceStatus:
    """kindscrap í”„ë¡œê·¸ë¨ ìƒíƒœ ì²´í¬"""
    try:
        current_date = datetime.now().strftime("%Y_%m_%d")
        log_dir = Path(program_config["base_dir"]) / "log"
        
        if not log_dir.exists():
            return ServiceStatus(
                name=program_config["name"],
                description=program_config["description"],
                status="ERROR",
                message=f"Log directory not found: {log_dir}",
                base_dir=program_config["base_dir"],
                scheduler=program_config["scheduler"],
                run_time=program_config["run_time"]
            )
        
        # ì˜¤ëŠ˜ ë‚ ì§œì˜ ë¡œê·¸ íŒŒì¼ ì°¾ê¸°
        log_file_pattern = f"kindscrap_{current_date}.log"
        log_files = list(log_dir.glob(log_file_pattern))
        
        if not log_files:
            return ServiceStatus(
                name=program_config["name"],
                description=program_config["description"],
                status="ERROR",
                message=f"Today's log file not found: {log_file_pattern}",
                base_dir=program_config["base_dir"],
                scheduler=program_config["scheduler"],
                run_time=program_config["run_time"]
            )
        
        log_file = log_files[0]
        
        # ë¡œê·¸ íŒŒì¼ì—ì„œ ERROR ì²´í¬
        try:
            with open(log_file, 'r', encoding='utf-8') as f:
                content = f.read()
                if "ERROR" in content:
                    return ServiceStatus(
                        name=program_config["name"],
                        description=program_config["description"],
                        status="ERROR",
                        message="ERROR found in today's log file",
                        last_log=log_file.name,
                        last_updated=datetime.fromtimestamp(log_file.stat().st_mtime),
                        base_dir=program_config["base_dir"],
                        scheduler=program_config["scheduler"],
                        run_time=program_config["run_time"]
                    )
        except Exception as e:
            return ServiceStatus(
                name=program_config["name"],
                description=program_config["description"],
                status="ERROR",
                message=f"Failed to read log file: {str(e)}",
                base_dir=program_config["base_dir"],
                scheduler=program_config["scheduler"],
                run_time=program_config["run_time"]
            )
        
        return ServiceStatus(
            name=program_config["name"],
            description=program_config["description"],
            status="OK",
            message="No errors found in today's log",
            last_log=log_file.name,
            last_updated=datetime.fromtimestamp(log_file.stat().st_mtime),
            base_dir=program_config["base_dir"],
            scheduler=program_config["scheduler"],
            run_time=program_config["run_time"]
        )
        
    except Exception as e:
        return ServiceStatus(
            name=program_config["name"],
            description=program_config["description"],
            status="ERROR",
            message=f"Unexpected error: {str(e)}",
            base_dir=program_config["base_dir"],
            scheduler=program_config["scheduler"],
            run_time=program_config["run_time"]
        )

def check_fund_mail(program_config: Dict[str, Any]) -> ServiceStatus:
    """fund_mail í”„ë¡œê·¸ë¨ ìƒíƒœ ì²´í¬"""
    try:
        current_date = datetime.now()
        date_str = current_date.strftime("%Y_%m_%d")
        data_dir = Path(program_config["base_dir"]) / "data" / date_str
        
        if not data_dir.exists():
            return ServiceStatus(
                name=program_config["name"],
                description=program_config["description"],
                status="ERROR",
                message=f"Today's data directory not found: {date_str}",
                base_dir=program_config["base_dir"],
                scheduler=program_config["scheduler"],
                run_time=program_config["run_time"]
            )
        
        # fm_YYYY_MM_DD_HH_MM.db íŒ¨í„´ì˜ íŒŒì¼ ì°¾ê¸°
        db_pattern = f"fm_{date_str}_*.db"
        db_files = list(data_dir.glob(db_pattern))
        
        if not db_files:
            return ServiceStatus(
                name=program_config["name"],
                description=program_config["description"],
                status="ERROR",
                message=f"No database files found today with pattern: {db_pattern}",
                base_dir=program_config["base_dir"],
                scheduler=program_config["scheduler"],
                run_time=program_config["run_time"]
            )
        
        # ê°€ì¥ ìµœê·¼ íŒŒì¼ ì°¾ê¸° (íŒŒì¼ëª…ì˜ ì‹œê°„ ê¸°ì¤€)
        def extract_time_from_filename(filename):
            match = re.search(r'fm_\d{4}_\d{2}_\d{2}_(\d{2})_(\d{2})\.db', filename.name)
            if match:
                return int(match.group(1)), int(match.group(2))
            return 0, 0
        
        latest_db = max(db_files, key=extract_time_from_filename)
        
        # íŒŒì¼ëª…ì—ì„œ ì‹œê°„ ì¶”ì¶œ
        match = re.search(r'fm_(\d{4})_(\d{2})_(\d{2})_(\d{2})_(\d{2})\.db', latest_db.name)
        if not match:
            return ServiceStatus(
                name=program_config["name"],
                description=program_config["description"],
                status="ERROR",
                message="Invalid filename format",
                base_dir=program_config["base_dir"],
                scheduler=program_config["scheduler"],
                run_time=program_config["run_time"]
            )
        
        year, month, day, hour, minute = map(int, match.groups())
        file_datetime = datetime(year, month, day, hour, minute)
        
        # í˜„ì¬ ì‹œê°„ - 10ë¶„ê³¼ ë¹„êµ
        time_threshold = current_date - timedelta(minutes=10)
        
        if file_datetime < time_threshold:
            return ServiceStatus(
                name=program_config["name"],
                description=program_config["description"],
                status="WARNING",
                message=f"Latest file is older than 10 minutes: {latest_db.name}",
                last_log=latest_db.name,
                last_updated=file_datetime,
                base_dir=program_config["base_dir"],
                scheduler=program_config["scheduler"],
                run_time=program_config["run_time"]
            )
        
        return ServiceStatus(
            name=program_config["name"],
            description=program_config["description"],
            status="OK",
            message="Latest file is within 10 minutes",
            last_log=latest_db.name,
            last_updated=file_datetime,
            base_dir=program_config["base_dir"],
            scheduler=program_config["scheduler"],
            run_time=program_config["run_time"]
        )
        
    except Exception as e:
        return ServiceStatus(
            name=program_config["name"],
            description=program_config["description"],
            status="ERROR",
            message=f"Unexpected error: {str(e)}",
            base_dir=program_config["base_dir"],
            scheduler=program_config["scheduler"],
            run_time=program_config["run_time"]
        )

def get_service_status_data() -> HealthCheckResponse:
    """ëª¨ë“  ì„œë¹„ìŠ¤ ìƒíƒœë¥¼ ì²´í¬í•˜ì—¬ ì‘ë‹µ ë°ì´í„° ìƒì„±"""
    programs = config.list_programs()
    services = []
    
    for program in programs:
        if program["name"] == "auto_esafe":
            status = check_auto_esafe(program)
        elif program["name"] == "kindscrap":
            status = check_kindscrap(program)
        elif program["name"] == "fund_mail":
            status = check_fund_mail(program)
        else:
            # ì•Œë ¤ì§€ì§€ ì•Šì€ í”„ë¡œê·¸ë¨
            status = ServiceStatus(
                name=program["name"],
                description=program["description"],
                status="ERROR",
                message="Unknown program type",
                base_dir=program["base_dir"],
                scheduler=program["scheduler"],
                run_time=program["run_time"]
            )
        services.append(status)
    
    # ì „ì²´ ìƒíƒœ ì§‘ê³„
    ok_count = sum(1 for service in services if service.status == "OK")
    error_count = sum(1 for service in services if service.status == "ERROR")
    warning_count = sum(1 for service in services if service.status == "WARNING")
    total_services = len(services)
    
    # ì „ì²´ ìƒíƒœ íŒë‹¨
    if error_count > 0:
        overall_status = "ERROR"
        summary = f"{error_count} service(s) have critical errors"
    elif warning_count > 0:
        overall_status = "WARNING"
        summary = f"{warning_count} service(s) have warnings"
    else:
        overall_status = "OK"
        summary = "All services are running normally"
    
    return HealthCheckResponse(
        timestamp=datetime.now(),
        overall_status=overall_status,
        services=services,
        summary=summary,
        total_services=total_services,
        ok_count=ok_count,
        error_count=error_count,
        warning_count=warning_count
    )

@router.get("/api/status", response_model=HealthCheckResponse)
def get_status_api():
    """JSON API - ì‹œìŠ¤í…œ ìƒíƒœ ì¡°íšŒ"""
    return get_service_status_data()

@router.get("/", response_class=HTMLResponse, include_in_schema=False)
def dashboard(request: Request):
    """ëŒ€ì‹œë³´ë“œ HTML í˜ì´ì§€"""
    html_content = """
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>BATMON Dashboard - System Health Monitor</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            
            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background-color: #f5f5f5;
                color: #333;
            }
            
            .header {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 20px 0;
                text-align: center;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            }
            
            .header h1 {
                font-size: 2.5em;
                margin-bottom: 10px;
            }
            
            .header .subtitle {
                font-size: 1.2em;
                opacity: 0.9;
            }
            
            .container {
                max-width: 1200px;
                margin: 0 auto;
                padding: 20px;
            }
            
            .status-overview {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }
            
            .status-card {
                background: white;
                border-radius: 10px;
                padding: 20px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                text-align: center;
                transition: transform 0.2s;
            }
            
            .status-card:hover {
                transform: translateY(-2px);
            }
            
            .status-card h3 {
                font-size: 2em;
                margin-bottom: 10px;
            }
            
            .status-card p {
                font-size: 1.1em;
                color: #666;
            }
            
            .services-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
                gap: 20px;
                margin-bottom: 20px;
            }
            
            .service-card {
                background: white;
                border-radius: 10px;
                padding: 20px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                border-left: 5px solid #ddd;
                transition: all 0.3s;
            }
            
            .service-card.ok {
                border-left-color: #28a745;
            }
            
            .service-card.warning {
                border-left-color: #ffc107;
            }
            
            .service-card.error {
                border-left-color: #dc3545;
            }
            
            .service-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 15px;
            }
            
            .service-name {
                font-size: 1.3em;
                font-weight: bold;
            }
            
            .status-badge {
                padding: 5px 12px;
                border-radius: 20px;
                font-size: 0.9em;
                font-weight: bold;
                text-transform: uppercase;
            }
            
            .status-badge.ok {
                background-color: #d4edda;
                color: #155724;
            }
            
            .status-badge.warning {
                background-color: #fff3cd;
                color: #856404;
            }
            
            .status-badge.error {
                background-color: #f8d7da;
                color: #721c24;
            }
            
            .service-description {
                color: #666;
                margin-bottom: 15px;
                font-size: 0.95em;
            }
            
            .service-details {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px;
                font-size: 0.9em;
            }
            
            .detail-item {
                display: flex;
                flex-direction: column;
            }
            
            .detail-label {
                font-weight: bold;
                color: #555;
                margin-bottom: 2px;
            }
            
            .detail-value {
                color: #777;
            }
            
            .last-updated {
                text-align: center;
                margin-top: 20px;
                padding: 15px;
                background: white;
                border-radius: 10px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            }
            
            .loading {
                text-align: center;
                padding: 40px;
                color: #666;
                font-size: 1.1em;
            }
            
            .error-message {
                background: #f8d7da;
                color: #721c24;
                padding: 15px;
                border-radius: 5px;
                margin-bottom: 20px;
                border: 1px solid #f5c6cb;
            }
            
            @media (max-width: 768px) {
                .services-grid {
                    grid-template-columns: 1fr;
                }
                
                .service-details {
                    grid-template-columns: 1fr;
                }
            }
        </style>
    </head>
    <body>
        <div class="header">
            <h1>ğŸ–¥ï¸ BATMON Dashboard</h1>
            <p class="subtitle">Windows 11 Server Monitoring System</p>
        </div>
        
        <div class="container">
            <div id="overview" class="status-overview">
                <div class="status-card">
                    <h3 id="total-services">-</h3>
                    <p>Total Services</p>
                </div>
                <div class="status-card">
                    <h3 id="ok-count" style="color: #28a745;">-</h3>
                    <p>Running OK</p>
                </div>
                <div class="status-card">
                    <h3 id="warning-count" style="color: #ffc107;">-</h3>
                    <p>Warnings</p>
                </div>
                <div class="status-card">
                    <h3 id="error-count" style="color: #dc3545;">-</h3>
                    <p>Errors</p>
                </div>
            </div>
            
            <div id="services-container" class="services-grid">
                <div class="loading">Loading system status...</div>
            </div>
            
            <div class="last-updated">
                <p>Last Updated: <span id="last-updated">-</span></p>
                <p>Auto-refresh every 30 seconds</p>
            </div>
        </div>

        <script>
            let refreshInterval;
            
            async function fetchStatus() {
                try {
                    const response = await fetch('/api/status');
                    const data = await response.json();
                    updateDashboard(data);
                } catch (error) {
                    console.error('Failed to fetch status:', error);
                    showError('Failed to connect to monitoring service');
                }
            }
            
            function updateDashboard(data) {
                // Update overview
                document.getElementById('total-services').textContent = data.total_services;
                document.getElementById('ok-count').textContent = data.ok_count;
                document.getElementById('warning-count').textContent = data.warning_count;
                document.getElementById('error-count').textContent = data.error_count;
                
                // Update services
                const container = document.getElementById('services-container');
                container.innerHTML = '';
                
                data.services.forEach(service => {
                    const serviceCard = createServiceCard(service);
                    container.appendChild(serviceCard);
                });
                
                // Update timestamp
                const timestamp = new Date(data.timestamp).toLocaleString('ko-KR');
                document.getElementById('last-updated').textContent = timestamp;
                
                // Update page title based on overall status
                document.title = `BATMON - ${data.overall_status} (${data.error_count} errors)`;
            }
            
            function createServiceCard(service) {
                const card = document.createElement('div');
                card.className = `service-card ${service.status.toLowerCase()}`;
                
                const lastUpdated = service.last_updated 
                    ? new Date(service.last_updated).toLocaleString('ko-KR')
                    : 'N/A';
                
                const runTimeDisplay = service.run_time.length > 0 
                    ? service.run_time.join(', ') 
                    : 'Continuous';
                
                card.innerHTML = `
                    <div class="service-header">
                        <div class="service-name">${service.name}</div>
                        <div class="status-badge ${service.status.toLowerCase()}">${service.status}</div>
                    </div>
                    <div class="service-description">${service.description}</div>
                    <div class="service-details">
                        <div class="detail-item">
                            <div class="detail-label">Base Directory:</div>
                            <div class="detail-value">${service.base_dir}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Scheduler:</div>
                            <div class="detail-value">${service.scheduler}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Run Time:</div>
                            <div class="detail-value">${runTimeDisplay}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Last Updated:</div>
                            <div class="detail-value">${lastUpdated}</div>
                        </div>
                    </div>
                    <div style="margin-top: 10px; font-weight: bold; color: ${getStatusColor(service.status)};">
                        ${service.message}
                    </div>
                    ${service.last_log ? `<div style="margin-top: 5px; font-size: 0.8em; color: #666;">Last Log: ${service.last_log}</div>` : ''}
                `;
                
                return card;
            }
            
            function getStatusColor(status) {
                switch (status.toLowerCase()) {
                    case 'ok': return '#28a745';
                    case 'warning': return '#ffc107';
                    case 'error': return '#dc3545';
                    default: return '#6c757d';
                }
            }
            
            function showError(message) {
                const container = document.getElementById('services-container');
                container.innerHTML = `<div class="error-message">${message}</div>`;
            }
            
            function startAutoRefresh() {
                fetchStatus(); // ì¦‰ì‹œ í•œ ë²ˆ ì‹¤í–‰
                refreshInterval = setInterval(fetchStatus, 30000); // 30ì´ˆë§ˆë‹¤ ìƒˆë¡œê³ ì¹¨
            }
            
            function stopAutoRefresh() {
                if (refreshInterval) {
                    clearInterval(refreshInterval);
                }
            }
            
            // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ìƒˆë¡œê³ ì¹¨ ì‹œì‘
            document.addEventListener('DOMContentLoaded', startAutoRefresh);
            
            // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ìƒˆë¡œê³ ì¹¨ ì •ì§€
            window.addEventListener('beforeunload', stopAutoRefresh);
            
            // íƒ­ì´ í™œì„±í™”/ë¹„í™œì„±í™”ë  ë•Œ ìƒˆë¡œê³ ì¹¨ ì œì–´
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    stopAutoRefresh();
                } else {
                    startAutoRefresh();
                }
            });
        </script>
    </body>
    </html>
    """
    return HTMLResponse(content=html_content)
```